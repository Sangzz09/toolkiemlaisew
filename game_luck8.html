<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Luck8</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <script>
    // Hàm chuyển hướng nhanh
    function redirectToIndex() {
        window.location.replace('/menu');
    }

    // Chạy hàm hiện nội dung ngay lập tức
    document.addEventListener('DOMContentLoaded', () => {
        document.body.style.display = 'block'; 
    });
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Share Tech Mono',monospace;
      background:radial-gradient(circle at 10% 10%, rgba(0,0,0,0.6), rgba(0,0,0,1));
      color:#00ff00;height:100vh;overflow:hidden;
      display: none; 
    }

    .btn, .footer-text, .prediction-box .label, .prediction-box .circle, .prediction-box .close-btn {
        font-weight: 700 !important;
    }
    
    .overlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #0052D4, #4364F7, #6FB1FC);
      z-index: 100;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 20px;
      transition: opacity 0.3s ease;
    }

    #fullscreenIframe{position:fixed;inset:0;width:100%;height:100%;border:0;z-index:1;}

    .panel, #predictionPopup, .footer-text { display: flex; }

    .panel{
      position:fixed;left:12px;top:12px;z-index:55;
      display:flex;flex-direction:column;gap:8px;width:180px;
    }
    .btn{
      background:rgba(0,255,0,0.09);
      color:#00ff00;border:1px solid rgba(0,255,0,0.25);
      padding:6px 8px; 
      border-radius:8px;font-size:13px;text-align:center;
      cursor:pointer;transition:0.12s;
    }
    .btn:hover{transform:translateY(-2px)}
    .btn:disabled{cursor:not-allowed;opacity:0.6;transform:none;}
    .logout-btn{
      background:linear-gradient(90deg,#2b0000,#700000);color:#fff;border:1px solid #ff3b3b;
    }

    .prediction-box {
      position: fixed;
      bottom: 120px; 
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(90deg, #005600, #00008B); 
      border-radius: 18px; 
      border: 1px solid #ffcc00; 
      padding: 6px 18px; 
      display: none;
      align-items: flex-end;
      justify-content: center;
      gap: 13px; 
      box-shadow: 0 0 15px 5px rgba(255, 204, 0, 0.3); 
      z-index: 99999;
      cursor: move;
      touch-action: none;
    }
    
    .prediction-box .item {
        display:flex;
        flex-direction:column;
        align-items:center;
    }
    
    .prediction-box .label {
        font-weight:700; 
        font-size:17px; 
        margin-bottom:5px; 
        color:#000000; 
    }
    
    .prediction-box .circle {
        width:38px; 
        height:38px; 
        border-radius:50%; 
        border:3px solid #ffcc00; 
        display:flex; 
        align-items:center; 
        justify-content:center; 
        font-weight:700; 
        font-size:17px; 
        opacity:0.2;
        transition: opacity 0.3s, box-shadow 0.3s, background 0.3s;
        color: #000; 
    }
    
    .circle.active.tai {
      background: #00ff00;
      opacity:1; 
      box-shadow:0 0 10px #00ff00, 0 0 20px #00ff00;
    }

    .circle.active.xiu {
      background: #ff0000; 
      opacity:1; 
      box-shadow:0 0 10px #ff0000, 0 0 20px #ff0000;
    }
    
    .prediction-box .logo {
        width:53px; 
        height:auto;
        margin-bottom: 2px;
    }
    
    .prediction-box .close-btn {
        position:absolute;
        top:0px;
        right:4px;
        cursor:pointer;
        font-size:17px; 
        font-weight:700; 
        color:#000000; 
    }
    
    .footer-text{
        position:fixed;
        bottom:8px;
        right:12px; 
        font-size:13px;
        color:#00ff00;
        text-shadow:0 0 5px #00ff00,0 0 10px #00ff00;
        z-index:50;
        display:flex; 
        align-items: center; 
        justify-content: flex-end;
        line-height: 1.4;
        padding: 5px 8px; 
        background: rgba(0, 0, 0, 0.3); 
        border-radius: 5px;
        white-space: nowrap; 
        font-weight: 700; 
    }

    @keyframes textBlinkSmooth {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    .blinking-text {
      animation: textBlinkSmooth 1s ease-in-out infinite; 
    }

    @media(max-width:480px){
      #predictionPopup{width:190px; height: 85px; right:8px;top:60px} 
      .prediction-box { padding: 5px 15px; } 
      .prediction-box .circle { width: 36px; height: 36px; } 
    }
  </style>
</head>
<body>
  <iframe id="fullscreenIframe" src="https://japb3yw.bbb5lol.cc/mobile/?inviteCode=4592386#/" name="fullscreenIframe"></iframe>
  <div class="panel">
    <button id="activateBtn" class="btn">Kích Hoạt</button>
    <button id="logoutBtn" class="btn logout-btn">Quay Về</button>
  </div>
  
  <div id="predictionPopup" class="prediction-box" role="dialog" aria-hidden="true">
    <div class="item">
        <span class="label">TÀI</span>
        <div id="taiCircle" class="circle tai"></div>
    </div>
    <img src="https://i.postimg.cc/D0Yj2Wht/IMG-7951.png" alt="Logo" class="logo">
    <div class="item">
        <span class="label">XỈU</span>
        <div id="xiuCircle" class="circle xiu"></div>
    </div>
    <span class="close-btn">✖</span>
  </div>

  <div class="footer-text">
    <div id="footerInfo" class="blinking-text">
      Phiên: --- | Dự Đoán: --- | Độ Tin Cậy: ---
    </div>
  </div>
  <script>
  const fullscreenIframe = document.getElementById('fullscreenIframe');
  const activateBtn = document.getElementById('activateBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const predictionPopup = document.getElementById('predictionPopup');
  const footerInfo = document.getElementById('footerInfo');
  const taiCircle = document.getElementById('taiCircle');
  const xiuCircle = document.getElementById('xiuCircle');
  const closePopup = predictionPopup.querySelector('.close-btn');

  let fetchIntervalId = null;
  let blinkIntervalId = null; 
  let currentSessionId = null; 
  let isAwaitingNewSession = false; 
  const API_URL = '/api/predict/luck8';

  logoutBtn.addEventListener('click', () => {
    window.location.href = '/menu';
  });

  function capitalize(s) {
    if (!s) return '---';
    return s.charAt(0).toUpperCase() + s.slice(1).toLowerCase();
  }

  async function fetchPrediction() {
    try {
      const response = await fetch(API_URL);
      if (!response.ok) throw new Error('Network response was not ok');
      const json = await response.json();
      if (!json.ok) throw new Error(json.error || 'API Error');
      const data = json.result;
      console.log("Dữ liệu API:", data);

      const rawPrediction = data.du_doan;
      const predictedResult = rawPrediction && rawPrediction.toLowerCase() === 'tài' ? 'T' : 'X';
      const nextSessionId = data.phien ? parseInt(data.phien) + 1 : '---';
      let confidence = data.do_tin_cay;
      if (confidence && confidence <= 1) confidence = Math.round(confidence * 100);
      
      const formattedPrediction = capitalize(rawPrediction);
      const formattedConfidence = confidence ? `${confidence}%` : '---';

      footerInfo.textContent = `Phiên: ${nextSessionId} | Dự Đoán: ${formattedPrediction} | Độ Tin Cậy: ${formattedConfidence}`;

      if (isAwaitingNewSession) {
          console.log(`Đang chờ hết 6 giây cho phiên ${currentSessionId}. Bỏ qua nháy.`);
          return;
      }
      
      if (currentSessionId && currentSessionId !== nextSessionId) {
        console.log(`Phiên thay đổi: ${currentSessionId} -> ${nextSessionId}. Bắt đầu ngưng nháy 6 giây.`);
        stopBlink(); 
        isAwaitingNewSession = true; 
        currentSessionId = nextSessionId; 

        setTimeout(() => {
          isAwaitingNewSession = false; 
          console.log(`Hết 6 giây. Bắt đầu nháy cho phiên mới: ${currentSessionId}`);
          startPredictionBlink(predictedResult); 
        }, 6000); 
      } else if (currentSessionId === null || currentSessionId === nextSessionId) {
          currentSessionId = nextSessionId; 
          if (!blinkIntervalId) {
             startPredictionBlink(predictedResult);
          }
      } 

    } catch (error) {
      console.error("Lỗi khi fetch API:", error);
      footerInfo.textContent = 'Lỗi kết nối API!';
      stopBlink();
    }
  }

  function startPredictionBlink(predictedResult) {
      stopBlink(); 
      const targetCircle = (predictedResult === 'T') ? taiCircle : xiuCircle;
      const otherCircle = (predictedResult === 'T') ? xiuCircle : taiCircle;
      otherCircle.classList.remove("active"); 
      let isBlinking = true;
      blinkIntervalId = setInterval(()=>{
          if(isBlinking){
              targetCircle.classList.add("active");
          } else {
              targetCircle.classList.remove("active");
          }
          isBlinking = !isBlinking;
      }, 500); 
  }

  function stopBlink(){
      if(blinkIntervalId){
          clearInterval(blinkIntervalId);
          blinkIntervalId = null;
          taiCircle.classList.remove("active");
          xiuCircle.classList.remove("active");
      }
  }

  activateBtn.addEventListener('click', () => {
    if (activateBtn.disabled) return; 
    predictionPopup.style.display = 'flex';
    activateBtn.disabled = true;
    activateBtn.textContent = 'Đang Chạy';
    activateBtn.style.fontWeight = '700'; 
    currentSessionId = null; 
    isAwaitingNewSession = false;
    stopBlink(); 
    fetchPrediction(); 
    fetchIntervalId = setInterval(fetchPrediction, 1000); 
  });

  closePopup.addEventListener('click', () => {
    predictionPopup.style.display = 'none';
    if (fetchIntervalId) {
      clearInterval(fetchIntervalId);
      fetchIntervalId = null;
      activateBtn.disabled = false;
      activateBtn.textContent = 'Kích Hoạt';
      activateBtn.style.fontWeight = '700'; 
      stopBlink(); 
      footerInfo.textContent = 'Phiên: --- | Dự Đoán: --- | Độ Tin Cậy: ---'; 
    }
  });

  (function makeDraggable(el){
    let startX = 0, startY = 0;
    const dragStart = (e) => {
        if (e.target.classList.contains("close-btn")) return;
        e.preventDefault();
        const rect = el.getBoundingClientRect();
        let clientX = e.type.includes("touch") ? e.touches[0].clientX : e.clientX;
        let clientY = e.type.includes("touch") ? e.touches[0].clientY : e.clientY;
        startX = clientX - rect.left;
        startY = clientY - rect.top;
        if (el.style.position !== 'fixed' || el.style.transform !== "none") {
             el.style.left = rect.left + 'px';
             el.style.top = rect.top + 'px';
             el.style.position = 'fixed';
             el.style.right = "auto";
             el.style.bottom = "auto";
             el.style.transform = "none"; 
        }
        document.addEventListener("mousemove", dragging);
        document.addEventListener("mouseup", dragEnd);
        document.addEventListener("touchmove", dragging, { passive: false });
        document.addEventListener("touchend", dragEnd);
    };
    const dragging = (e) => {
        let clientX = e.type.includes("touch") ? e.touches[0].clientX : e.clientX;
        let clientY = e.type.includes("touch") ? e.touches[0].clientY : e.clientY;
        let newX = clientX - startX;
        let newY = clientY - startY;
        const maxX = window.innerWidth - el.offsetWidth;
        const maxY = window.innerHeight - el.offsetHeight;
        newX = Math.max(0, Math.min(newX, maxX));
        newY = Math.max(0, Math.min(newY, maxY));
        el.style.left = newX + "px";
        el.style.top = newY + "px";
        e.preventDefault();
    };
    const dragEnd = () => {
        document.removeEventListener("mousemove", dragging);
        document.removeEventListener("mouseup", dragEnd);
        document.removeEventListener("touchmove", dragging);
        document.removeEventListener("touchend", dragEnd);
    };
    el.addEventListener("mousedown", dragStart);
    el.addEventListener("touchstart", dragStart);
  })(predictionPopup);
  </script>
</body>
</html>